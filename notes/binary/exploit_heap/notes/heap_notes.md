### Table of Contents
    **GENERAL**
1. General Notes
2. Heap & Main Arena ARE AT DIFFERENT ADDRESSES
     **CHUNKS**
3. Chunks in General
  + Size Field & Flags
4. Top Chunk
      **BINS**
5. Fastbins
      **OTHER**
6. Arenas



# Heap Notes


----------------------------------------------------------------------------------------------------


### 1. GENERAL NOTES

* Which `heap exploit exploitation` to which _version of libc_ look at pdf's _mitigation section_
 + `tcache` make `malloc` _easier to exploit_
 
 
* Heap allocates in _16 bytye_ (`0x10`) increments


* `Malloc` considers a `heap` to _start 16 bytes before_ the metadata
 + So if I'm _targeting_ **a specific function** remember to _subtract 16_
  - Example
    `dup = malloc(0x28, p64(libc.sym.__free_hook - 16))`

  - If the size field has a flag, you can know whether the qword before size is for chunk that the size is for


* Overflowing `userdata` (_even off by one_) corrupts the _size of the next chunk_
 + or the _top chunk's size_



*  `Process Memory Map`
  + Application
  + Heap         <----in theory, heap can overwrite all the way down to stack
  + Libraries
  + Stack

----------------------------------------------------------------------------------------------------


###### ===== 2. Heap & Main Arena ARE AT DIFFERENT ADDRESSES ===== ######


+ EXAMPLES
 - Note that the `heap` and `main_area` are at **DIFFERENT ADDRESSES**
```pwndbg> vis_heap_chunks
0x5555553000  0x0000000000000000 0x0000000000000051
 [...]

0x5555553160  0x0000000000000000 0x00000000000020ea1   <---- TOP CHUNK
```

```pwndbg> dq &main_arena
0x00007ffff7dd060   0000000000000000 0000000000000001
 [...]
```


----------------------------------------------------------------------------------------------------


### 3. CHUNKS IN GENERAL

 **===== SIZE FIELD & FLAGS =====**
 
   + **SIZE of chunk**s go up by `16` / `0x10`
    - So you see `0x20`, `0x30`, etc.
    - i.e. the _leftmost digit of the hex_
    

   + The _number AFTER the 16th place_ (2nd digit from the right)...
    - ...if that value is **greater than 0, a FLAG has been set**:
    
    - `non_main_arena` -> 4 -> binary: _100_
    - `is_mmapped`     -> 2 -> binary: _010_
    - `prev_inuse`     -> 1 -> binary: _001_


    * **Combo of flags** can be used  
        (ex: 3 would be `prev_inuse(1)`&`is_mmapped(2)` -> 1+2=3)  
        
        
     ```
       _____________the 3 and the 6 represent the size of the chunk
       |      |
       v      v
     0x30   0x61
        ^      ^
        |      |
        ------------------if this is NOT 0, there's a flag set
     ```

----------------------------------------------------------------------------------------------------

### 4. TOP CHUNK

   + Called the top chunk because it's at the highest address
   + Bottom when viewing from low to high addresses
   
   + Top chunk has a size field field as well
   + Top chunk's `size field` is **NOT subject to INTEGRITY CHECKS** until `GLIBC 2.29`
    - Variable called `system_mem` is checked
    
   + Evertime you call `malloc`
    1. malloc `breaks a piece` of this _top chunk_
      - **starting from lowest address**
    2. Gives it a _size field_
    3. ...and hands a _pointer to its userdata_
    4. If you _run out of memory_ from `top chunk`, `malloc` will _extend_ this `top chunk`


----------------------------------------------------------------------------------------------------


### 5. FASTBINS

+ If there's an _address in fastbin_, it was stored after the previous `malloc`
   (from the qword right after the size field in the chunk)
   
+ `dq &main_arena 14` -> see fastbins in qwords (1 means beginning of fastbins)

+ bin means list

+ `Fastbin` is a _singular non-circular free list_ that each hold a free chunk of a certain size
 - bins are based on size from _0x20~0xa0_
 - if a chunk is null _0x0_ you're at the **end of a list**
    ```
    The malloc source describes fastbins as “special bins that hold returned chunks without
    consolidating their spaces”
    ```

+ While there are only 7 fastbins by default...
 - `mallopt()` function can be used to change this number by modifying the `global_max_fast` variable


----------------------------------------------------------------------------------------------------


### 6. ARENAS

+ `Arenas`: structures in which _malloc_ keeps all of its _non-inline metadata_,
            consisting primarily of the _heads of each_ of those _free lists_
            
 - `arena` is a `malloc_state struct`
            
 - `Single arena`: administrate multiple heaps
 
 - `New area`: is created with an initial heap every time a _thread uses malloc for the first time_
               up to a _limit_ based on _# of cores_
  * The `main thread` gets a _special arena_  called the `main arena` which is in the
    _libc .data section_


----------------------------------------------------------------------------------------------------



